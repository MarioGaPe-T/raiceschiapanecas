<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Productos – Panel Raíces Chiapanecas</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="panel-wrapper">
    <div class="auth-card panel-card">
      <div class="auth-inner">

        <!-- Header -->
        <div class="panel-header">
          <div class="panel-header-left">
            <div class="auth-logo">RC</div>
            <div>
              <h1 class="auth-title">Productos</h1>
              <p class="auth-subtitle">
                Administra el catálogo, precios, stock e imágenes de los productos.
              </p>
            </div>
          </div>
          <div class="panel-header-right">
            <a href="/admin" class="btn btn-edit">Volver a admin</a>
            <button id="logoutBtn" class="btn btn-logout">Cerrar sesión</button>
          </div>
        </div>

        <!-- Toolbar -->
        <div
          class="panel-toolbar"
          style="display:flex; gap:0.75rem; align-items:center; margin-bottom:1rem; flex-wrap:wrap;"
        >
          <input
            id="searchInput"
            class="auth-input"
            type="text"
            placeholder="Buscar por nombre, descripción, SKU, categoría o productor..."
            style="flex: 1 1 240px;"
          />

          <select id="filterCategory" class="auth-input" style="flex:0 0 200px;">
            <option value="all">Todas las categorías</option>
          </select>

          <select id="sortSelect" class="auth-input" style="flex:0 0 180px;">
            <option value="newest">Más recientes</option>
            <option value="name_asc">Nombre A–Z</option>
            <option value="price_asc">Precio: menor a mayor</option>
            <option value="price_desc">Precio: mayor a menor</option>
          </select>

          <button
            id="btnAddProduct"
            class="btn btn-edit"
            style="white-space:nowrap;"
          >
            Agregar producto
          </button>
        </div>

        <!-- Tabla de productos -->
        <div class="panel-table-container">
          <table class="customers-table">
            <thead>
              <tr>
                <th>Imagen</th>
                <th>ID</th>
                <th>Nombre</th>
                <th>SKU</th>
                <th>Categoría</th>
                <th>Productor</th>
                <th>Precio</th>
                <th>Estado</th>
                <th>Stock</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="productsBody">
              <!-- Filas generadas por JS -->
            </tbody>
          </table>

          <div id="panelMessage" class="auth-message" style="display:none;"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const searchInput    = document.getElementById('searchInput');
    const filterCategory = document.getElementById('filterCategory');
    const sortSelect     = document.getElementById('sortSelect');
    const btnAddProduct  = document.getElementById('btnAddProduct');
    const productsBody   = document.getElementById('productsBody');
    const panelMessage   = document.getElementById('panelMessage');

    let allProducts   = [];
    let allCategories = [];

    function showPanelMessage(type, text) {
      panelMessage.style.display = 'block';
      panelMessage.className = 'auth-message ' + (type === 'error' ? 'error' : 'success');
      panelMessage.textContent = text;
    }

    function clearPanelMessage() {
      panelMessage.style.display = 'none';
      panelMessage.textContent = '';
    }

    // Cargar categorías para el filtro
    async function loadMeta() {
      try {
        const res  = await fetch('/products/meta');
        const data = await res.json();

        allCategories = data.categories || [];

        filterCategory.innerHTML = '<option value="all">Todas las categorías</option>';
        allCategories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = String(cat.id);
          opt.textContent = cat.name;
          filterCategory.appendChild(opt);
        });
      } catch (err) {
        console.error('Error al cargar meta de productos:', err);
      }
    }

    // Cargar productos
    async function loadProducts() {
      clearPanelMessage();
      productsBody.innerHTML = '<tr><td colspan="10">Cargando productos...</td></tr>';

      try {
        const res  = await fetch('/products');
        const data = await res.json();
        allProducts = Array.isArray(data) ? data : [];
        applyFilters();
      } catch (err) {
        console.error(err);
        productsBody.innerHTML = '<tr><td colspan="10">Error al cargar productos.</td></tr>';
        showPanelMessage('error', 'Error al cargar productos desde el servidor.');
      }
    }

    // Aplicar búsqueda + filtros + orden
    function applyFilters() {
      const term    = searchInput.value.toLowerCase().trim();
      const catId   = filterCategory.value;
      const sortMode = sortSelect.value;

      let list = allProducts.slice();

      // Filtro de texto: nombre, descripción, SKU, categoría, productor
      if (term) {
        list = list.filter(p => {
          const text = (
            (p.name || '') + ' ' +
            (p.description || '') + ' ' +
            (p.sku || '') + ' ' +
            (p.category_name || '') + ' ' +
            (p.producer_name || '')
          ).toLowerCase();
          return text.includes(term);
        });
      }

      // Filtro por categoría
      if (catId !== 'all') {
        list = list.filter(p => String(p.category_id) === String(catId));
      }

      // Orden
      switch (sortMode) {
        case 'name_asc':
          list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          break;
        case 'price_asc':
          list.sort((a, b) => Number(a.price || 0) - Number(b.price || 0));
          break;
        case 'price_desc':
          list.sort((a, b) => Number(b.price || 0) - Number(a.price || 0));
          break;
        case 'newest':
        default:
          list.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          break;
      }

      renderProducts(list);
    }

    // Pintar tabla
    function renderProducts(list) {
      productsBody.innerHTML = '';

      if (!list.length) {
        productsBody.innerHTML = '<tr><td colspan="10">No se encontraron productos.</td></tr>';
        return;
      }

      list.forEach(p => {
        const tr = document.createElement('tr');

        const imgUrl = p.primary_image_url || '/img/product-placeholder.svg';
        const stockQty = typeof p.stock_quantity !== 'undefined'
          ? p.stock_quantity
          : (p.stock || 0);

        tr.innerHTML = `
          <td>
            <img
              src="${imgUrl}"
              alt="${p.name || ''}"
              style="width:40px;height:40px;object-fit:cover;border-radius:0.35rem;"
            >
          </td>
          <td>${p.id}</td>
          <td>${p.name || ''}</td>
          <td>${p.sku || ''}</td>
          <td>${p.category_name || ''}</td>
          <td>${p.producer_name || ''}</td>
          <td>$${Number(p.price || 0).toFixed(2)}</td>
          <td>${p.status || ''}</td>
          <td>${stockQty}</td>
          <td class="actions">
            <button class="btn btn-edit" data-action="edit" data-id="${p.id}">
              Editar
            </button>
            <button class="btn btn-delete" data-action="delete" data-id="${p.id}">
              Eliminar
            </button>
          </td>
        `;
        productsBody.appendChild(tr);
      });
    }

    // Eventos de búsqueda / filtros
    searchInput.addEventListener('input', applyFilters);
    filterCategory.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applyFilters);

    // Botón "Agregar producto" → otra página
    btnAddProduct.addEventListener('click', () => {
      window.location.href = '/products/new';
    });

    // Acciones de la tabla
    productsBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const action = btn.getAttribute('data-action');
      const id     = btn.getAttribute('data-id');

      if (action === 'edit') {
        window.location.href = `/products/${id}/edit`;
        return;
      }

      if (action === 'delete') {
        const confirmar = window.confirm(`¿Seguro que deseas eliminar el producto #${id}?`);
        if (!confirmar) return;

        try {
          const res  = await fetch(`/products/${id}`, { method: 'DELETE' });
          const data = await res.json();

          if (res.ok) {
            showPanelMessage('success', data.message || 'Producto eliminado correctamente.');
            await loadProducts();
          } else {
            showPanelMessage('error', data.error || 'No se pudo eliminar el producto.');
          }
        } catch (err) {
          console.error(err);
          showPanelMessage('error', 'Error de conexión al eliminar el producto.');
        }
      }
    });

    // Logout
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        const confirmar = window.confirm('¿Seguro que deseas cerrar sesión?');
        if (!confirmar) return;

        try {
          const res  = await fetch('/logout', { method: 'POST' });
          const data = await res.json();
          if (res.ok) {
            alert(data.message || 'Sesión cerrada.');
            window.location.href = '/login';
          } else {
            alert(data.error || 'No se pudo cerrar sesión.');
          }
        } catch (err) {
          console.error(err);
          alert('Error de conexión al cerrar sesión.');
        }
      });
    }

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await loadMeta();
      await loadProducts();
    });
  </script>
</body>
</html>
