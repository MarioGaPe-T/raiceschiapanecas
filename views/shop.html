<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ra√≠ces Chiapanecas ‚Äì Tienda</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <!-- HEADER PRINCIPAL -->
  <header class="main-header">
    <div class="header-left">
      <div class="auth-logo">RC</div>
      <div>
        <div class="site-title">Ra√≠ces Chiapanecas</div>
        <div class="site-subtitle">
          Caf√©, miel, cacao, textiles y artesan√≠as de productores locales.
        </div>
      </div>
    </div>

    <div class="header-search">
      <input
        id="searchInput"
        class="auth-input header-search-input"
        type="text"
        placeholder="Buscar productos por nombre, descripci√≥n o SKU..."
      >
    </div>

    <div class="header-right">
      <div id="userInfo" class="shop-user">
        <a href="/login" class="auth-link">Iniciar sesi√≥n</a>
        <span>¬∑</span>
        <a href="/register" class="auth-link">Crear cuenta</a>
      </div>

      <button id="profileBtn" class="btn btn-edit" style="display:none;">
        Mi perfil
      </button>

      <button id="cartBtn" class="btn cart-btn">
        Carrito (<span id="cartCount">0</span>)
      </button>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-text">
      <h2>Conecta con el sabor de Chiapas</h2>
      <p>
        Productos seleccionados directamente de cooperativas y artesanos locales:
        caf√© de altura, miel multifloral, cacao, textiles y m√°s.
      </p>
    </div>
    <div class="hero-image"></div>
  </section>

  <!-- BARRA DE CATEGOR√çAS -->
  <section class="category-bar">
    <span class="site-subtitle">Explorar por categor√≠a:</span>
    <div id="categoryPills" class="category-pills">
      <!-- Aqu√≠ se inyectan los botones -->
    </div>
  </section>

  <!-- CAT√ÅLOGO -->
  <main class="shop-main">
    <h2>Productos recomendados</h2>
    <p class="site-subtitle">
      Explora los productos disponibles de productores chiapanecos.
    </p>

    <div id="productsContainer" class="shop-grid"></div>
    <p id="productsMessage" class="auth-subtitle" style="margin-top: 1rem; display:none;"></p>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const userInfoEl = document.getElementById('userInfo');
      const profileBtn = document.getElementById('profileBtn');
      const cartBtn = document.getElementById('cartBtn');
      const cartCountEl = document.getElementById('cartCount');

      const searchInput = document.getElementById('searchInput');
      const categoryPills = document.getElementById('categoryPills');
      const productsContainer = document.getElementById('productsContainer');
      const productsMessage = document.getElementById('productsMessage');

      let allProducts = [];
      let currentCategorySlug = 'todos';

      function formatMoney(value) {
        return '$' + Number(value).toFixed(2) + ' MXN';
      }

      function showProductsMessage(text) {
        if (!text) {
          productsMessage.style.display = 'none';
          return;
        }
        productsMessage.style.display = 'block';
        productsMessage.textContent = text;
      }

      function renderProducts(list) {
        productsContainer.innerHTML = '';

        if (!list || list.length === 0) {
          showProductsMessage('No se encontraron productos con los filtros actuales.');
          return;
        }

        showProductsMessage('');

        list.forEach((p) => {
          const card = document.createElement('article');
          card.className = 'product-card';

          const imgHtml = p.image_url
            ? '<img src="' + p.image_url + '" alt="' + p.name + '">'
            : '<div class="product-image-placeholder">RC</div>';

          card.innerHTML = `
            <div class="product-card-top">
              <div class="product-card-image">
                ${imgHtml}
              </div>
            </div>
            <div class="product-card-body">
              <h3 class="product-name">${p.name}</h3>
              <div class="product-price">${formatMoney(p.price)}</div>
              <div class="product-meta">
                ${p.category_name ? 'Categor√≠a: ' + p.category_name + '<br>' : ''}
                ${p.producer_name ? 'Productor: ' + p.producer_name + '<br>' : ''}
              </div>
              <p class="product-description">
                ${p.description || 'Producto chiapaneco de alta calidad.'}
              </p>
            </div>
            <div class="product-card-footer">
              <button
                class="auth-button add-to-cart-btn"
                data-id="${p.id}"
              >
                A√±adir al carrito
              </button>
            </div>
          `;

          productsContainer.appendChild(card);
        });

        attachAddToCartHandlers();
      }

      function filterAndRender() {
        const search = (searchInput.value || '').toLowerCase().trim();

        let filtered = allProducts;

        if (currentCategorySlug !== 'todos') {
          filtered = filtered.filter(
            (p) => p.category_slug === currentCategorySlug
          );
        }

        if (search) {
          filtered = filtered.filter((p) => {
            const haystack =
              (p.name || '') +
              ' ' +
              (p.description || '') +
              ' ' +
              (p.sku || '');
            return haystack.toLowerCase().includes(search);
          });
        }

        renderProducts(filtered);
      }

      function renderCategories(categories) {
        categoryPills.innerHTML = '';

        const allBtn = document.createElement('button');
        allBtn.className = 'category-pill active';
        allBtn.textContent = 'Todos';
        allBtn.dataset.slug = 'todos';
        categoryPills.appendChild(allBtn);

        categories.forEach((cat) => {
          const btn = document.createElement('button');
          btn.className = 'category-pill';
          btn.textContent = cat.name;
          btn.dataset.slug = cat.slug;
          categoryPills.appendChild(btn);
        });

        categoryPills.addEventListener('click', (e) => {
          const btn = e.target.closest('.category-pill');
          if (!btn) return;

          const slug = btn.dataset.slug;
          currentCategorySlug = slug;

          document
            .querySelectorAll('.category-pill')
            .forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');

          filterAndRender();
        });
      }

      function attachAddToCartHandlers() {
        document.querySelectorAll('.add-to-cart-btn').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            try {
              // üëâ Aqu√≠ cambiamos /api/cart/items por /api/cart/add
              const res = await fetch('/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: id, quantity: 1 }),
              });

              if (res.status === 401) {
                window.location.href = '/login';
                return;
              }

              const data = await res.json();
              if (!res.ok) throw new Error(data.error || 'No se pudo a√±adir al carrito');

              btn.textContent = 'A√±adido ‚úî';
              setTimeout(() => {
                btn.textContent = 'A√±adir al carrito';
              }, 1200);

              await updateCartCount();
            } catch (err) {
              console.error(err);
              alert(err.message || 'Error al a√±adir al carrito');
            }
          });
        });
      }

      async function updateCartCount() {
        try {
          const res = await fetch('/api/cart');
          if (!res.ok) {
            cartCountEl.textContent = '0';
            return;
          }
          const data = await res.json();
          const count = (data.items && data.items.length) || 0;
          cartCountEl.textContent = String(count);
        } catch (err) {
          console.error(err);
          cartCountEl.textContent = '0';
        }
      }

      cartBtn.addEventListener('click', () => {
        window.location.href = '/cart';
      });

      profileBtn.addEventListener('click', () => {
        window.location.href = '/profile';
      });

      async function loadUser() {
        try {
          const res = await fetch('/me');
          const data = await res.json();

          if (!data.loggedIn || !data.user) {
            userInfoEl.innerHTML = `
              <a href="/login" class="auth-link">Iniciar sesi√≥n</a>
              <span>¬∑</span>
              <a href="/register" class="auth-link">Crear cuenta</a>
            `;
            profileBtn.style.display = 'none';
          } else {
            const name =
              data.user.full_name && data.user.full_name.trim() !== ''
                ? data.user.full_name
                : data.user.email;

            userInfoEl.textContent = 'Hola, ' + name;
            profileBtn.style.display = 'inline-flex';
          }
        } catch (err) {
          console.error(err);
        }
      }

      async function loadCategories() {
        try {
          const res = await fetch('/api/categories');
          if (!res.ok) throw new Error('No se pudieron cargar las categor√≠as');
          const data = await res.json();
          renderCategories(data);
        } catch (err) {
          console.error(err);
          categoryPills.innerHTML =
            '<span class="site-subtitle">No se pudieron cargar las categor√≠as.</span>';
        }
      }

      async function loadProducts() {
        try {
          const res = await fetch('/api/products');
          if (!res.ok) throw new Error('No se pudieron cargar los productos');
          const data = await res.json();
          allProducts = data;
          filterAndRender();
        } catch (err) {
          console.error(err);
          showProductsMessage('Error al cargar productos desde el servidor.');
        }
      }

      searchInput.addEventListener('input', () => {
        filterAndRender();
      });

      (async () => {
        await loadUser();
        await loadCategories();
        await loadProducts();
        await updateCartCount();
      })();
    });
  </script>
</body>
</html>
