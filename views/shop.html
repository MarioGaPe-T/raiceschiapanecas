<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Raíces Chiapanecas – Tienda</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <!-- ===== Header principal ===== -->
  <header class="main-header">
    <!-- Logo + título -->
    <div class="header-left">
      <div class="auth-logo">RC</div>
      <div>
        <div class="site-title">Raíces Chiapanecas</div>
        <div class="site-subtitle">
          Productos chiapanecos directos de productores locales.
        </div>
      </div>
    </div>

    <!-- Buscador -->
    <div class="header-search">
      <input
        id="searchInput"
        type="text"
        class="auth-input"
        placeholder="Buscar café, miel, cacao..."
      >
      <button
        id="searchBtn"
        class="auth-button"
        style="width:auto; padding-inline:1rem;"
      >
        Buscar
      </button>
    </div>

    <!-- Área derecha: login / perfil / carrito -->
    <div class="header-right">
      <!-- Vista de invitado -->
      <div id="guestActions" class="shop-actions">
        <a href="/login" class="auth-link">Iniciar sesión</a>
        <a href="/register" class="auth-link">Crear cuenta</a>
        <button class="btn cart-btn">Carrito</button>
      </div>

      <!-- Vista de usuario logueado -->
      <div id="userActions" class="shop-actions" style="display:none;">
        <span id="userGreeting" class="shop-user"></span>
        <a href="/profile" class="auth-link">Mi perfil</a>
        <button id="logoutBtn" class="btn btn-logout">Salir</button>
        <button class="btn cart-btn">Carrito</button>
      </div>
    </div>
  </header>

  <!-- ===== Hero ===== -->
  <section class="hero">
    <div class="hero-text">
      <h2>Sabores auténticos de Chiapas</h2>
      <p>
        Descubre café de altura, miel multifloral, cacao artesanal y textiles
        hechos con dedicación por productores locales. Cada compra apoya
        directamente a familias chiapanecas.
      </p>
    </div>
    <div class="hero-image"></div>
  </section>

  <!-- ===== Barra de categorías ===== -->
  <section class="category-bar">
    <span style="font-size:0.85rem; font-weight:600; color:#374151;">
      Explorar por categoría:
    </span>
    <div id="categoryPills" class="category-pills">
      <!-- Pills generados por JS -->
    </div>
  </section>

  <!-- ===== Contenido principal: productos ===== -->
  <main class="shop-main">
    <h2 class="auth-title" style="margin-bottom:0.25rem;">
      Productos recomendados
    </h2>
    <p class="auth-subtitle" style="margin-bottom:0.9rem;">
      Explora los productos disponibles de productores chiapanecos.
    </p>

    <div id="shopMessage" class="auth-message" style="display:none;"></div>

    <div id="productsGrid" class="shop-grid">
      <!-- Tarjetas generadas por JS -->
    </div>
  </main>

  <script>
    // ===============================
    //   Header: usuario logueado / invitado
    // ===============================

    const guestActions = document.getElementById('guestActions');
    const userActions = document.getElementById('userActions');
    const userGreeting = document.getElementById('userGreeting');

    async function loadUser() {
      try {
        const res = await fetch('/me');
        if (!res.ok) throw new Error('Respuesta no OK en /me');

        const data = await res.json();

        if (data.loggedIn && data.user) {
          userGreeting.textContent = `Hola, ${data.user.full_name}`;
          guestActions.style.display = 'none';
          userActions.style.display = 'flex';
        } else {
          guestActions.style.display = 'flex';
          userActions.style.display = 'none';
        }
      } catch (err) {
        console.error('Error al cargar usuario /me:', err);
        guestActions.style.display = 'flex';
        userActions.style.display = 'none';
      }
    }

    // Cerrar sesión desde la barra de arriba
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        const confirmar = window.confirm('¿Seguro que deseas cerrar sesión?');
        if (!confirmar) return;

        try {
          const res = await fetch('/logout', { method: 'POST' });
          const data = await res.json();
          if (res.ok) {
            alert(data.message || 'Sesión cerrada.');
            window.location.href = '/';
          } else {
            alert(data.error || 'No se pudo cerrar sesión.');
          }
        } catch (err) {
          console.error(err);
          alert('Error de conexión al cerrar sesión.');
        }
      });
    }

    // ===============================
    //   Tienda: categorías + productos
    // ===============================

    const categoryPills = document.getElementById('categoryPills');
    const productsGrid = document.getElementById('productsGrid');
    const shopMessage = document.getElementById('shopMessage');

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');

    // Estado en memoria
    let allProducts = [];
    let currentCategoryId = ''; // '' = Todos
    let currentSearchTerm = '';

    function showShopMessage(type, text) {
      shopMessage.style.display = 'block';
      shopMessage.className = 'auth-message ' + (type === 'error' ? 'error' : 'success');
      shopMessage.textContent = text;
    }

    function clearShopMessage() {
      shopMessage.style.display = 'none';
      shopMessage.textContent = '';
    }

    // ----- Cargar categorías -----
    async function loadCategories() {
      try {
        const res = await fetch('/api/categories');
        if (!res.ok) throw new Error('Respuesta no OK en /api/categories');

        const categories = await res.json();

        categoryPills.innerHTML = '';

        // Pill "Todos"
        const pillAll = document.createElement('button');
        pillAll.textContent = 'Todos';
        pillAll.className = 'category-pill active';
        pillAll.dataset.id = '';
        categoryPills.appendChild(pillAll);

        // Resto de categorías
        if (Array.isArray(categories) && categories.length > 0) {
          categories.forEach((cat) => {
            const pill = document.createElement('button');
            pill.textContent = cat.name;
            pill.className = 'category-pill';
            pill.dataset.id = String(cat.id);
            categoryPills.appendChild(pill);
          });
        }

        // Listener de click para filtros
        categoryPills.addEventListener('click', (e) => {
          const btn = e.target;
          if (!btn.classList.contains('category-pill')) return;

          // Quitar active a todas
          document.querySelectorAll('.category-pill').forEach((p) => {
            p.classList.remove('active');
          });

          // Activar pill clickeada
          btn.classList.add('active');

          currentCategoryId = btn.dataset.id || '';
          applyFilters();
        });
      } catch (err) {
        console.error('Error al cargar categorías:', err);
        categoryPills.innerHTML = '';
        const pillAll = document.createElement('button');
        pillAll.textContent = 'Todos';
        pillAll.className = 'category-pill active';
        pillAll.dataset.id = '';
        categoryPills.appendChild(pillAll);

        showShopMessage('error', 'No se pudieron cargar las categorías.');
      }
    }

    // ----- Cargar productos -----
    async function loadProducts() {
      clearShopMessage();
      productsGrid.innerHTML = '<p>Cargando productos...</p>';

      try {
        const res = await fetch('/api/products');
        if (!res.ok) throw new Error('Respuesta no OK en /api/products');

        const data = await res.json();
        allProducts = Array.isArray(data) ? data : [];

        applyFilters();
      } catch (err) {
        console.error('Error al cargar productos:', err);
        productsGrid.innerHTML = '<p>No se pudieron cargar los productos.</p>';
        showShopMessage('error', 'Error al cargar productos desde el servidor.');
      }
    }

    // ----- Aplicar filtros (categoría + búsqueda) -----
    function applyFilters() {
      if (!Array.isArray(allProducts) || allProducts.length === 0) {
        productsGrid.innerHTML = '<p>No hay productos disponibles.</p>';
        return;
      }

      const term = currentSearchTerm.trim().toLowerCase();
      let filtered = allProducts.slice();

      // Filtrar por categoría
      if (currentCategoryId) {
        filtered = filtered.filter(
          (p) => String(p.category_id) === String(currentCategoryId)
        );
      }

      // Filtrar por búsqueda
      if (term) {
        filtered = filtered.filter((p) => {
          const name = (p.name || '').toLowerCase();
          const desc = (p.description || '').toLowerCase();
          const categoryName = (p.category_name || '').toLowerCase();
          return (
            name.includes(term) ||
            desc.includes(term) ||
            categoryName.includes(term)
          );
        });
      }

      renderProducts(filtered);
    }

    // ----- Render de tarjetas -----
    function renderProducts(products) {
      productsGrid.innerHTML = '';

      if (!products || products.length === 0) {
        productsGrid.innerHTML = '<p>No se encontraron productos con esos filtros.</p>';
        return;
      }

      products.forEach((p) => {
        const card = document.createElement('article');
        card.className = 'product-card';

        const producerName = p.producer_name || '';
        const categoryName = p.category_name || '';

        card.innerHTML = `
          <div>
            <div class="product-name">${p.name || ''}</div>
            <div class="product-price">$${p.price || '0.00'} MXN</div>
            <div class="product-meta">
              ${categoryName ? `Categoría: ${categoryName}` : ''}
              ${producerName ? ` · Productor: ${producerName}` : ''}
            </div>
            <div class="product-description">
              ${p.description || ''}
            </div>
          </div>
          <div class="product-card-footer" style="margin-top:0.5rem;">
            <button class="auth-button" style="width:100%;">Agregar al carrito</button>
          </div>
        `;

        productsGrid.appendChild(card);
      });
    }

    // ----- Búsqueda -----
    function setupSearch() {
      searchBtn.addEventListener('click', () => {
        currentSearchTerm = searchInput.value || '';
        applyFilters();
      });

      searchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          currentSearchTerm = searchInput.value || '';
          applyFilters();
        }
      });
    }

    // ===============================
    //   Init
    // ===============================

    document.addEventListener('DOMContentLoaded', () => {
      loadUser();
      loadCategories();
      loadProducts();
      setupSearch();
    });
  </script>
</body>
</html>
